  test:
    stage: test
    tags:
      - dockerfasibio
    image: node:9
    script:
      - npm install
      - npm test -- --coverage=true
    coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
    artifacts:
      paths:
        - coverage/
    only:
      - /^([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
      - /^rc_([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
      - master
    
  pages:
    stage: testPages
    tags:
        - dockerfasibio
    dependencies:
      - test
    script:
      - mv coverage/lcov-report public/
    artifacts:
      paths:
        - public
      expire_in: 30 days
    only:
      - master
  build:
    stage: build
    tags: 
      - dockerfasibio
    image: docker
    script:
      - sh -x ./dockerize/buildDocker.sh latest
    only:
      - master
  publish:
    stage: publish
    tags: 
      - dockerfasibio
    image: docker
    script:
      - sh -x ./dockerize/publish.sh latest
    only:
      - master
  buildTag:
    stage: build
    tags: 
      - dockerfasibio
    image: docker
    script:
      - sh -x ./dockerize/buildDocker.sh $CI_COMMIT_REF_NAME
    only:
      - /^([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
      - /^rc_([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/

    
  publishTag:
    stage: publish
    tags: 
      - dockerfasibio
    image: docker
    script:
      - sh -x ./dockerize/publish.sh $CI_COMMIT_REF_NAME
    only:
      - /^([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
      - /^rc_([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
  
  cleanup:
    stage: cleanup
    tags: 
      - dockerfasibio
    image: docker
    script:
      - docker rmi $(docker images |grep 'fasibio/graphqldockerproxy')
    only:
      - /^([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
      - /^rc_([0-9]{0,3})\.([0-9]{0,3})\.([0-9]{0,3})$/
      - master
  stages: 
    - test
    - testPages
    - build
    - publish